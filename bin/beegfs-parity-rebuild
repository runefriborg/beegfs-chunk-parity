#!/bin/bash
set -o nounset
set -o pipefail
set -o errexit

dname="${1:-}"
last_successful_timestamp_file="/opt/$dname/spool/last-gen-timestamp"

function usage {
echo "usage: beegfs-parity-rebuild <config>"
echo "   or: beegfs-parity-rebuild --help"
}

case $dname in
    -h|--help)
    usage
    exit 0
    ;;
    "")
    usage
    exit 1
    ;;
    *)
    ;;
esac

function must_have_file {
    f="/opt/$dname/$1"
    if [ ! -e "$f" ]; then
        echo "Can't find file '$f'" 1>&2
        exit 1
    fi
}
must_have_file "etc/basedir"
must_have_file "etc/hosts"

if [[ $EUID -ne 0 ]]; then
    echo "You need root privilege to run this program" 1>&2
    exit 1
fi
if [ "`hostname -s`" != "s10n50" ]; then
    echo "Should only run on s10n50" 1>&2
    exit 1
fi

# Make sure all necessary folders are present
mkdir --parents "/opt/$dname/run"
mkdir --parents "/opt/$dname/spool"

(
if flock --exclusive --nonblock 500; then
    if [ ! -f "$last_successful_timestamp_file" ]; then
        echo "** Error: Does not look like you have built any pariy" 1>&2
        exit 1
    fi

    rebuild_host="s11i04"
    rebuild_host_index=`awk "/$rebuild_host/ {print FNR}" "/opt/$dname/etc/hosts"`
    rebuild_target=`expr $rebuild_host_index - 1`
    safe_host=`comm -13 <(echo $rebuild_host) "/opt/$dname/etc/hosts" | head -n 1`
    ssh $rebuild_host rm -rf /opt/$dname/spool/db
    scp -pr $safe_host:/opt/$dname/spool/db $rebuild_host:/opt/$dname/spool/db

    base_dir=`cat /opt/$dname/etc/basedir`
    spool="/opt/$dname/spool/"
    mkdir --parents $spool
    echo `hostname -s` > /opt/$dname/run/hosts
    cat "/opt/$dname/etc/hosts" >> "/opt/$dname/run/hosts"
    mpirun="mpirun --hostfile /opt/$dname/run/hosts"
    $mpirun ./bp-parity-rebuild $rebuild_target $base_dir $spool/data /tmp/$base_dir-corrupted_chunks /opt/$dname/spool/db
    # Collect list of potentially corrupt chunks
    for h in `cat /opt/$dname/etc/hosts`; do
        ssh $h cat /tmp/$base_dir-corrupted_chunks
    done | sort -u > $spool/corrupted_chunks
else
    echo "** Error: Can't acquire lock, is the program already running?" 1>&2
fi
) 500>"/opt/$dname/run/lock"

